<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.github.lishangbu.avalon.authorization.mapper.PermissionMapper">
  <resultMap id="permissionResultMap" type="io.github.lishangbu.avalon.authorization.entity.Permission">
    <!--@Table permission-->
    <id column="id" property="id"/>
    <result column="name" property="name"/>
    <result column="code" property="code"/>
    <result column="type" property="type"/>
    <result column="parent_id" property="parentId"/>
    <result column="path" property="path"/>
    <result column="redirect" property="redirect"/>
    <result column="icon" property="icon"/>
    <result column="component" property="component"/>
    <result column="layout" property="layout"/>
    <result column="keep_alive" property="keepAlive"/>
    <result column="method" property="method"/>
    <result column="description" property="description"/>
    <result column="show" property="show"/>
    <result column="enabled" property="enabled"/>
    <result column="order_num" property="orderNum"/>
  </resultMap>

  <sql id="permissionColumnList">
    id, name, code, type, parent_id, path, redirect, icon, component, layout, keep_alive, method, description, "show", enabled, order_num
  </sql>

  <!--通过id查询单条权限数据-->
  <select id="selectById" resultMap="permissionResultMap">
    select
    <include refid="permissionColumnList"/>
    from permission p
    where p.id = #{id}
  </select>

  <!--新增权限-->
  <insert id="insert" keyProperty="id" useGeneratedKeys="true">
    insert into permission
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="name != null and name != ''">
        name,
      </if>
      <if test="code != null and code != ''">
        code,
      </if>
      <if test="type != null and type != ''">
        type,
      </if>
      <if test="parentId != null">
        parent_id,
      </if>
      <if test="path != null and path != ''">
        path,
      </if>
      <if test="redirect != null and redirect != ''">
        redirect,
      </if>
      <if test="icon != null and icon != ''">
        icon,
      </if>
      <if test="component != null and component != ''">
        component,
      </if>
      <if test="layout != null and layout != ''">
        layout,
      </if>
      <if test="keepAlive != null">
        keep_alive,
      </if>
      <if test="method != null and method != ''">
        method,
      </if>
      <if test="description != null and description != ''">
        description,
      </if>
      <if test="show != null">
        show,
      </if>
      <if test="enabled != null">
        enabled,
      </if>
      <if test="orderNum != null">
        order_num,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id},
      </if>
      <if test="name != null and name != ''">
        #{name},
      </if>
      <if test="code != null and code != ''">
        #{code},
      </if>
      <if test="type != null and type != ''">
        #{type},
      </if>
      <if test="parentId != null">
        #{parentId},
      </if>
      <if test="path != null and path != ''">
        #{path},
      </if>
      <if test="redirect != null and redirect != ''">
        #{redirect},
      </if>
      <if test="icon != null and icon != ''">
        #{icon},
      </if>
      <if test="component != null and component != ''">
        #{component},
      </if>
      <if test="layout != null and layout != ''">
        #{layout},
      </if>
      <if test="keepAlive != null">
        #{keepAlive},
      </if>
      <if test="method != null and method != ''">
        #{method},
      </if>
      <if test="description != null and description != ''">
        #{description},
      </if>
      <if test="show != null">
        #{show},
      </if>
      <if test="enabled != null">
        #{enabled},
      </if>
      <if test="orderNum != null">
        #{orderNum},
      </if>
    </trim>
  </insert>

  <!--通过id修改权限-->
  <update id="updateById">
    update permission
    <set>
      <if test="name != null and name != ''">
        name = #{name},
      </if>
      <if test="code != null and code != ''">
        code = #{code},
      </if>
      <if test="type != null and type != ''">
        type = #{type},
      </if>
      <if test="parentId != null">
        parent_id = #{parentId},
      </if>
      <if test="path != null and path != ''">
        path = #{path},
      </if>
      <if test="redirect != null and redirect != ''">
        redirect = #{redirect},
      </if>
      <if test="icon != null and icon != ''">
        icon = #{icon},
      </if>
      <if test="component != null and component != ''">
        component = #{component},
      </if>
      <if test="layout != null and layout != ''">
        layout = #{layout},
      </if>
      <if test="keepAlive != null">
        keep_alive = #{keepAlive},
      </if>
      <if test="method != null and method != ''">
        method = #{method},
      </if>
      <if test="description != null and description != ''">
        description = #{description},
      </if>
      <if test="show != null">
        show = #{show},
      </if>
      <if test="enabled != null">
        enabled = #{enabled},
      </if>
      <if test="orderNum != null">
        order_num = #{orderNum},
      </if>
    </set>
    where id = #{id}
  </update>

  <!--通过id删除权限-->
  <delete id="deleteById">
    delete
    from permission
    where id = #{id}
  </delete>

  <!--查询所有权限-->
  <select id="selectAll" resultMap="permissionResultMap">
    select
    <include refid="permissionColumnList"/>
    from permission
    <where>
      <if test="type!=null">
        and type=#{type}
      </if>
      <if test="parentId!=null">
        and parent_id=#{parentId}
      </if>
    </where>
  </select>

  <!--通过角色代码查询所有权限-->
  <select id="selectAllByRoleCodes" resultMap="permissionResultMap">
    <choose>
      <when test="roleCodes != null and roleCodes.size() > 0">
        select distinct
        p.id,
        p.name, p.code, p.type, p.parent_id, p.path, p.redirect, p.icon, p.component, p.layout, p.keep_alive, p.method,
        p.description, p."show", p.enabled, p.order_num

        from permission p
        inner join role_permission_relation rpr on rpr.permission_id = p.id
        inner join role r on r.id = rpr.role_id
        where r.code in
        <foreach item="item" collection="roleCodes" open="(" separator="," close=")">
          #{item}
        </foreach>
      </when>
      <!-- 当 roleCodes 为空时，直接返回空结果，避免意外返回所有权限 -->
      <otherwise>
        from permission
        <include refid="permissionColumnList"/>
        from permission p
        where 1 = 0
      </otherwise>
    </choose>
  </select>
</mapper>
